# å¯¼å…¥éœ€è¦ç”¨åˆ°çš„æ¨¡å—
import random  # ç”¨äºéšæœºé€‰æ‹©å­¦ç”Ÿ
import json  # ç”¨äºå¤„ç†JSONæ ¼å¼çš„å†å²è®°å½•
from datetime import datetime, timedelta  # ç”¨äºå¤„ç†æ—¥æœŸæ—¶é—´ï¼Œåˆ¤æ–­3å¤©å†…çš„è®°å½•
import os  # ç”¨äºæ“ä½œæ–‡ä»¶ï¼ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ç­‰ï¼‰

# å­¦ç”Ÿåå•æ•°æ®ï¼ˆä»æ–‡æ¡£ä¸­æå–çš„æ‰€æœ‰å­¦ç”Ÿå§“åï¼‰
STUDENT_LIST = [
    "åˆ˜æµ·ç‡•", "èµµæ™Ÿç¾½", "åˆ˜ä½³æ¬£", "å‘¨ä½³æ—º", "éƒ­ç‚³æ¸…", "ä»»æ˜è¾‰", "å†¯ç‚³æ ‹", "ç®¡ä¸­æ­£",
    "å´å†¬å‡¡", "æœ±å›½æ ‹", "æ›¾å‡¡æ”¿", "æå“²", "éŸ©å®œæ’", "ç‹æ–‡æ´‹", "è¦ƒä¸œ", "ç‹ç•™æ ¹", "å¹²é›¨çª",
    "ç‹å‰‘æ¶›", "å²æ™¯éºŸ", "ç‹ç”Ÿè¿œ", "åˆ˜å»ºæˆ", "ç‹æ¢…æ–‡", "ææ˜Ÿè’´", "èˆ’è‰¾å‡Œ", "å‘¨è°Šå",
    "å¼ æ–‡å¼€", "æå»ºè¡Œ", "æƒ æ™¨å®‡", "æœ±ç£Š", "æˆ´ä½³ä¹", "ç²Ÿå˜‰æ ‹", "äºæˆé¾™", "æ±Ÿæ–‡æ°",
    "è°¢å²©", "æœæ–‡è¾‰", "èµµæ˜å®½", "ä¾¯æ–‡æµ©", "æ¥¼é£˜è±ª", "é™ˆç»´æ˜Š", "å¾ä¿Šè±ª", "é»„ç¨‹",
    "åˆ˜æ¢¦é£", "å‘¨æœä¹", "è«æ—ä¸›", "ç‹è½©", "éŸ©é›¨è¾°", "éƒ­æ€ç¦", "é»„ä»²ç§‹", "è‚å¿ƒé›¨",
    "å¼ å¹´", "å§šä½³è‰¯", "é›·é”¦æµ©", "å®£æ™ºè¶…", "æ›¾å®‡å®", "æ±ªå»ºæ°", "æ®µå¤©åš", "ç‹å­èµ«",
    "ç‹åš", "å‘¨ç¥çƒ", "é™ˆé‘«", "å­™å¡¬ä¸œ", "å®‹è¶Šæ‰¬", "è¢æ‰§æˆˆ", "å¸­ä¼ é‘«", "ç‹å¿—åš",
    "é©¬å­¦è¶…", "ç‹ä¸€æ™®", "å•æµå‘", "æ–¹å¯è¶…", "æ›¹æ°", "ä¾¯å›½å", "æ—è´»èƒœ", "é—«ç‘ç¥¥"
]

# å†å²è®°å½•å­˜å‚¨çš„æ–‡ä»¶åï¼ˆJSONæ ¼å¼ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
HISTORY_FILE = "roll_call_history.json"


def load_history():
    """
    åŠ è½½ç‚¹åå†å²è®°å½•
    åŠŸèƒ½ï¼šä»JSONæ–‡ä»¶ä¸­è¯»å–ä¹‹å‰çš„ç‚¹åè®°å½•ï¼Œæ–¹ä¾¿åˆ¤æ–­å“ªäº›å­¦ç”Ÿ3å¤©å†…è¢«ç‚¹è¿‡å
    è¿”å›ï¼šå†å²è®°å½•åˆ—è¡¨ï¼ˆæ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¡ç‚¹åè®°å½•ï¼ŒåŒ…å«å­¦ç”Ÿå§“åã€æ—¥æœŸã€æ—¶é—´ï¼‰
    """
    # æ£€æŸ¥å†å²è®°å½•æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›ç©ºåˆ—è¡¨
    if not os.path.exists(HISTORY_FILE):
        return []
    try:
        # æ‰“å¼€æ–‡ä»¶å¹¶è¯»å–å†…å®¹ï¼Œç”¨json.loadè½¬æ¢ä¸ºPythonåˆ—è¡¨
        with open(HISTORY_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except json.JSONDecodeError:
        # å¦‚æœæ–‡ä»¶æŸåï¼ˆæ¯”å¦‚æ‰‹åŠ¨ä¿®æ”¹æ ¼å¼é”™è¯¯ï¼‰ï¼Œè¿”å›ç©ºåˆ—è¡¨é¿å…ç¨‹åºå´©æºƒ
        return []


def save_history(history):
    """
    ä¿å­˜ç‚¹åå†å²è®°å½•
    åŠŸèƒ½ï¼šå°†æœ€æ–°çš„ç‚¹åè®°å½•å†™å…¥JSONæ–‡ä»¶ï¼Œç¡®ä¿ä¸‹æ¬¡æ‰“å¼€ç¨‹åºæ—¶è®°å½•ä¸ä¸¢å¤±
    å‚æ•°ï¼šhistory - åŒ…å«æ‰€æœ‰ç‚¹åè®°å½•çš„åˆ—è¡¨
    """
    # æ‰“å¼€æ–‡ä»¶å¹¶å†™å…¥å†…å®¹ï¼Œç”¨json.dumpè½¬æ¢ä¸ºJSONæ ¼å¼ï¼ˆensure_ascii=Falseä¿è¯ä¸­æ–‡æ­£å¸¸æ˜¾ç¤ºï¼‰
    with open(HISTORY_FILE, "w", encoding="utf-8") as f:
        json.dump(history, f, ensure_ascii=False, indent=2)


def get_available_students(history):
    """
    è·å–3æ—¥å†…æœªè¢«ç‚¹åçš„å­¦ç”Ÿåˆ—è¡¨ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    åŠŸèƒ½ï¼šè¿‡æ»¤å‡ºæœ€è¿‘3å¤©å†…æ²¡æœ‰è¢«ç‚¹åçš„å­¦ç”Ÿï¼Œé¿å…é‡å¤ç‚¹å
    å‚æ•°ï¼šhistory - æ‰€æœ‰ç‚¹åè®°å½•çš„åˆ—è¡¨
    è¿”å›ï¼šå¯ç”¨å­¦ç”Ÿçš„åˆ—è¡¨ï¼ˆ3å¤©å†…æ²¡è¢«ç‚¹è¿‡åçš„å­¦ç”Ÿï¼‰
    """
    # è®¡ç®—3å¤©å‰çš„æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦åœ¨3å¤©å†…
    three_days_ago = (datetime.now() - timedelta(days=3)).strftime("%Y-%m-%d")

    # ç”¨é›†åˆå­˜å‚¨3å¤©å†…è¢«ç‚¹åçš„å­¦ç”Ÿï¼ˆé›†åˆçš„ç‰¹ç‚¹æ˜¯è‡ªåŠ¨å»é‡ï¼Œé¿å…é‡å¤åˆ¤æ–­ï¼‰
    recent_called = set()
    # éå†æ¯æ¡å†å²è®°å½•ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨3å¤©å†…
    for record in history:
        # å¦‚æœè®°å½•çš„æ—¥æœŸ >= 3å¤©å‰çš„æ—¥æœŸï¼Œè¯´æ˜æ˜¯3å¤©å†…çš„è®°å½•
        if record["date"] >= three_days_ago:
            # å°†è¯¥å­¦ç”ŸåŠ å…¥"3å¤©å†…å·²ç‚¹å"é›†åˆ
            recent_called.add(record["student"])

    # è¿‡æ»¤å‡ºä¸åœ¨"3å¤©å†…å·²ç‚¹å"é›†åˆä¸­çš„å­¦ç”Ÿï¼Œå°±æ˜¯å¯ç”¨çš„å­¦ç”Ÿ
    return [student for student in STUDENT_LIST if student not in recent_called]


def roll_call():
    """
    æ‰§è¡Œç‚¹åæ“ä½œï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    åŠŸèƒ½ï¼šéšæœºé€‰æ‹©ä¸€ä¸ª3å¤©å†…æ²¡è¢«ç‚¹åçš„å­¦ç”Ÿï¼Œè®°å½•è¿™æ¬¡ç‚¹åï¼Œå¹¶æ˜¾ç¤ºç»“æœ
    """
    # ç¬¬ä¸€æ­¥ï¼šåŠ è½½å†å²è®°å½•
    history = load_history()

    # ç¬¬äºŒæ­¥ï¼šè·å–å¯ç”¨å­¦ç”Ÿï¼ˆ3å¤©å†…æ²¡è¢«ç‚¹åçš„ï¼‰
    available = get_available_students(history)

    # å¦‚æœæ²¡æœ‰å¯ç”¨å­¦ç”Ÿï¼ˆæ‰€æœ‰äºº3å¤©å†…éƒ½è¢«ç‚¹è¿‡åï¼‰ï¼Œæç¤ºæ— æ³•ç‚¹å
    if not available:
        print("âš ï¸  æ‰€æœ‰å­¦ç”Ÿåœ¨3æ—¥å†…éƒ½å·²è¢«ç‚¹åï¼Œæœ¬æ¬¡æ— æ³•ç»§ç»­ç‚¹åï¼")
        return

    # ç¬¬ä¸‰æ­¥ï¼šä»å¯ç”¨å­¦ç”Ÿä¸­éšæœºé€‰ä¸€ä¸ª
    selected = random.choice(available)

    # ç¬¬å››æ­¥ï¼šè®°å½•æœ¬æ¬¡ç‚¹åçš„ä¿¡æ¯ï¼ˆå­¦ç”Ÿå§“åã€æ—¥æœŸã€æ—¶é—´ï¼‰
    current_date = datetime.now().strftime("%Y-%m-%d")  # å½“å‰æ—¥æœŸï¼ˆå¹´-æœˆ-æ—¥ï¼‰
    new_record = {
        "student": selected,  # è¢«ç‚¹åçš„å­¦ç”Ÿå§“å
        "date": current_date,  # ç‚¹åæ—¥æœŸ
        "time": datetime.now().strftime("%H:%M:%S")  # ç‚¹åæ—¶é—´ï¼ˆæ—¶:åˆ†:ç§’ï¼‰
    }

    # å°†æ–°è®°å½•æ·»åŠ åˆ°å†å²è®°å½•åˆ—è¡¨ï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶
    history.append(new_record)
    save_history(history)

    # ç¬¬äº”æ­¥ï¼šæ˜¾ç¤ºç‚¹åç»“æœ
    print("ğŸ‰ æœ¬æ¬¡ç‚¹åç»“æœï¼š")
    print(f"å§“åï¼š{selected}")
    print(f"æ—¶é—´ï¼š{current_date} {new_record['time']}")

    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼š3å¤©å†…å·²ç‚¹åå¤šå°‘äººï¼Œè¿˜å‰©å¤šå°‘äººå¯ä»¥ç‚¹
    print("\nğŸ“Š 3æ—¥å†…å·²ç‚¹åå­¦ç”Ÿæ•°ï¼š", len(STUDENT_LIST) - len(available))
    print("å‰©ä½™å¯ç‚¹åå­¦ç”Ÿæ•°ï¼š", len(available) - 1)  # å‡1æ˜¯å› ä¸ºåˆšç‚¹äº†1ä¸ª


def show_history():
    """
    æ˜¾ç¤ºç‚¹åå†å²è®°å½•
    åŠŸèƒ½ï¼šå±•ç¤ºæ‰€æœ‰å†å²ç‚¹åè®°å½•ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä¹‹å‰ç‚¹è¿‡å“ªäº›å­¦ç”Ÿ
    """
    # åŠ è½½å†å²è®°å½•
    history = load_history()

    # å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæç¤ºç”¨æˆ·
    if not history:
        print("ğŸ“œ æš‚æ— ç‚¹åå†å²è®°å½•")
        return

    # æ‰“å°æ‰€æœ‰å†å²è®°å½•ï¼ˆæŒ‰è®°å½•é¡ºåºï¼Œå¸¦åºå·ï¼‰
    print("ğŸ“œ ç‚¹åå†å²è®°å½•ï¼š")
    for i, record in enumerate(history, 1):  # enumerateä»1å¼€å§‹è®¡æ•°
        print(f"{i}. {record['student']} - {record['date']} {record['time']}")


def main():
    """
    ä¸»ç¨‹åºå…¥å£
    åŠŸèƒ½ï¼šæ˜¾ç¤ºèœå•ï¼Œæ¥æ”¶ç”¨æˆ·çš„é€‰æ‹©ï¼Œè°ƒç”¨å¯¹åº”çš„åŠŸèƒ½ï¼ˆç‚¹å/æŸ¥å†å²/é€€å‡ºï¼‰
    """
    # ç”¨å¾ªç¯è®©ç¨‹åºä¸€ç›´è¿è¡Œï¼Œç›´åˆ°ç”¨æˆ·é€‰æ‹©é€€å‡º
    while True:
        # æ‰“å°èœå•ç•Œé¢
        print("\n" + "=" * 30)
        print("          å­¦ç”Ÿç‚¹åå™¨")
        print("=" * 30)
        print("1. å¼€å§‹ç‚¹å")
        print("2. æŸ¥çœ‹å†å²è®°å½•")
        print("3. é€€å‡ºç¨‹åº")
        print("=" * 30)

        # æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„é€‰æ‹©
        choice = input("è¯·é€‰æ‹©æ“ä½œï¼ˆ1/2/3ï¼‰ï¼š")

        # æ ¹æ®ç”¨æˆ·é€‰æ‹©æ‰§è¡Œå¯¹åº”çš„åŠŸèƒ½
        if choice == "1":
            roll_call()  # è°ƒç”¨ç‚¹ååŠŸèƒ½
        elif choice == "2":
            show_history()  # è°ƒç”¨æŸ¥çœ‹å†å²è®°å½•åŠŸèƒ½
        elif choice == "3":
            print("ğŸ‘‹ ç¨‹åºå·²é€€å‡ºï¼Œæ„Ÿè°¢ä½¿ç”¨ï¼")
            break  # é€€å‡ºå¾ªç¯ï¼Œç¨‹åºç»“æŸ
        else:
            # å¦‚æœè¾“å…¥çš„ä¸æ˜¯1/2/3ï¼Œæç¤ºè¾“å…¥é”™è¯¯
            print("âŒ è¾“å…¥é”™è¯¯ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼")


# å¦‚æœç›´æ¥è¿è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œå°±æ‰§è¡Œmain()å‡½æ•°ï¼ˆç¨‹åºå…¥å£ï¼‰
if __name__ == "__main__":
    main()